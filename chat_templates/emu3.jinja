{% macro render_text(text, is_assistant) -%}{%- if is_assistant -%}{% generation %}{{ text }}{% endgeneration %}{%- else -%}{{ text }}{%- endif -%}{%- endmacro %}{% for message in messages %}{%- set is_assistant = (message.role == 'assistant') -%}{%- if message.role != 'system' -%}{{ message.role|upper ~ ': ' }}{%- endif -%}{# Case 1: content is a raw string (LLM style) #}{%- if message.content is string -%}{{ render_text(message.content, is_assistant) ~ ' ' }}{# Case 2: content is a single mapping/object with .type/.text #}{%- elif message.content is mapping -%}{%- if message.content.type == 'image' -%}<image>{%- elif message.content.type == 'text' and message.content.text is string -%}{{ render_text(message.content.text, is_assistant) ~ ' ' }}{%- else -%}{{ render_text(message.content|string, is_assistant) ~ ' ' }}{%- endif -%}{# Case 3: content is an iterable list (original multi-part format) #}{%- elif message.content is iterable -%}{# images first #}{%- for part in message.content if part.type == 'image' -%}<image>{%- endfor -%}{# then texts #}{%- for part in message.content if part.type == 'text' -%}{{ render_text(part.text, is_assistant) ~ ' ' }}{%- endfor -%}{%- endif -%}{% endfor %}{% if add_generation_prompt %}ASSISTANT:{% endif %}